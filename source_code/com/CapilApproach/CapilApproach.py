'''
@author: zhaohengyang
Copyright (c) 2015 zhaohengyang. All rights reserved.
'''

from com.decompiler.decompiler import *
from com.process.process import *

class CapilApproach(object):
    def __init__(self):
        self.processEn = processEngine()
        self.weka = WekaInterface()
        self.pTMgr = permissionMappingManager(databasePath)
        self.decompiler = Decompiler()    

    # step1
    def decompileSampleAPKs(self, sourcePath, destinationPath):       
        self.decompiler.decompilePath(sourcePath, destinationPath)
        
    # step2
    def extractFeaturesFromSampleSet(self):
        self.processEn.createSchema(additionalSampleArffilePath)
        self.processEn.processSamplesCheckingRuntime("/Users/zhaohengyang/Documents/malware detection/additional_malware/decompiled_samples", "malware", additionalSampleArffilePath) 
        #self.processEn.processSamplesCheckingRuntime("/Users/forensics/Documents/mike yang/mike_share_folder/mike new download/decompiled_samples", "benign", additionalSampleArffilePath) 
           
    # step3
    def featureRefinement(self, refinedArffPath):
        filteredData = self.weka.emlimitateUnusedFeature(wholeSetArffFilePath)
        tableName = TABLENAMES["DissimilarityAndSampleCoverage"]
        functionInfo = self.weka.showRankingByDissimilarityAndSampleCoverage(filteredData)
        self.pTMgr.writeTopAPIIntoDatabase(functionInfo, tableName) 
        [dummy, filteredData, dummy] = self.weka.attribueSelectionBasedOnRankingInDatabase(filteredData, 1, tableName)
        self.weka.save_Arff(filteredData, refinedArffPath)
        
    # step4    
    def useClassifierForUnkownSample(self, arffPath, unknowSampleArffPath):
        treeStr = self.weka.getDecisionTree(arffPath)
        tree = self.weka.parseDecisionTree(treeStr)
        self.weka.useTreeForNewApps(tree, unknowSampleArffPath)


        

    


        